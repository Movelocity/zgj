# 订阅系统实施范围划分

## 概述

本文档明确 `add-subscription-system` 提案的实施范围，将功能按优先级分为：
- **MVP** - 最小可行产品，必须实现的核心功能
- **V1** - 第一个完整版本，应该实现的功能
- **V2** - 未来增强，可以延后的功能
- **不做** - 明确排除的功能

---

## MVP - 最小可行产品（必须做）

### 目标
验证核心概念，支持基本的积分扣减和套餐管理，能够接入一个业务场景。

### 包含功能

#### 1. 数据库（必需的3张表）
- ✅ `billing_action_prices` - 动作计价表
- ✅ `billing_packages` - 套餐定义表
- ✅ `user_billing_packages` - 用户套餐表
- ❌ ~~`billing_consumption_records`~~ → **延后到V1**（MVP阶段可以不记录详细消费历史）

**对应任务**：`1.1-1.5` （简化版，只建3张表）

#### 2. 后端核心服务
- ✅ `billing/types.go` - 基础类型定义
- ✅ `billing/action_price_service.go` - 动作计价服务（只需读取功能）
  - GetActionPrice()
  - ListActionPrices()
- ✅ `billing/package_service.go` - 套餐管理服务（简化）
  - CreateBillingPackage()
  - GetBillingPackage()
  - ListBillingPackages()
- ✅ `billing/user_package_service.go` - 用户套餐服务（核心）
  - AssignBillingPackageToUser()
  - GetUserTotalCredits()
  - DeductCredits() - **核心功能**
  - CheckCredits()

**对应任务**：`2.1-2.5`, `3.1-3.3`, `4.1`（部分）, `5.1`（简化，不创建消费记录）

#### 3. 后端API（最少接口）
- ✅ **管理员API**:
  - `POST /api/admin/billing/packages` - 创建套餐
  - `GET /api/admin/billing/packages` - 查询套餐
  - `POST /api/admin/billing/user-packages` - 手动分配套餐
- ✅ **用户API**:
  - `GET /api/user/billing/credits` - 查看我的积分
- ✅ **内部API**:
  - `POST /api/internal/billing/credits/deduct` - 扣减积分

**对应任务**：`6.3`（部分）, `6.4`（部分）, `7.1`, `8.1`（部分）

#### 4. 前端（最小界面）
- ✅ `types/billing.ts` - 类型定义
- ✅ `api/billing.ts` - API封装（只封装MVP用到的接口）
- ✅ `admin/BillingPackageManagement.tsx` - 套餐管理页面（简化版，只支持创建和列表）
- ✅ `admin/UserBillingPackageList.tsx` - 用户套餐管理（只支持分配和查看）
- ✅ `components/billing/CreditsDisplay.tsx` - 积分显示组件

**对应任务**：`11.1`, `12.1`（部分）, `14.1-14.3`, `15.1-15.3`, `19.1`

#### 5. 业务接入（一个场景）
- ✅ **简历优化功能接入**
  - 优化前检查积分
  - 优化时扣减积分
  - 积分不足时友好提示

**对应任务**：`20.1-20.3`

#### 6. 预置数据
- ✅ 预置4个常见动作（resume_optimize, ai_chat, pdf_export, advanced_analysis）
- ✅ 创建1-2个默认套餐模板

**对应任务**：`1.6`, `24.1-24.2`（简化）

---

## V1 - 完整版本（应该做）

### 目标
提供完整的订阅管理能力，支持多业务场景，提供完善的管理和用户界面。

### 在MVP基础上新增

#### 1. 消费记录系统
- ✅ `billing_consumption_records` 表
- ✅ 消费记录服务（完整）
  - CreateConsumptionRecord()
  - GetUserConsumptionHistory()
  - RefundConsumption() - 消费回滚
- ✅ 消费记录API
  - 用户查看消费历史
  - 管理员消费统计（基础）

**对应任务**：`1.4`, `5.1-5.4`（完整版）, `6.5`, `7.2`, `8.1`（完整版）

#### 2. 动作计价管理（完整）
- ✅ 管理员可以创建、编辑、删除动作计价
- ✅ 管理员可以启用/禁用动作
- ✅ 前端动作计价管理界面

**对应任务**：`3.3`（完整版）, `6.2`, `13.1-13.5`

#### 3. 套餐管理（完整）
- ✅ 套餐编辑功能
- ✅ 套餐上下架功能
- ✅ 套餐可见性控制

**对应任务**：`3.4`（完整版）, `6.3`（完整版）, `14.4-14.6`

#### 4. 用户套餐激活和过期
- ✅ 套餐激活逻辑
- ✅ 定时任务清理过期套餐
- ✅ 前端显示过期状态

**对应任务**：`4.1`（完整版）, `10.1-10.4`

#### 5. 用户界面（完整）
- ✅ 我的套餐页面
- ✅ 消费历史页面
- ✅ 套餐卡片组件
- ✅ 动作价格标签

**对应任务**：`17.1-17.6`, `18.1-18.7`, `19.2-19.4`

#### 6. 多业务接入
- ✅ AI对话功能接入
- ✅ PDF导出功能接入
- ✅ 高级分析功能接入（如果存在）

**对应任务**：`21.1-21.3`, `22.1-22.3`

#### 7. 事件日志集成
- ✅ 套餐分配事件
- ✅ 积分扣减事件
- ✅ 消费回滚事件
- ✅ 动作价格修改事件

**对应任务**：`23.1-23.5`

#### 8. 新用户自动分配
- ✅ 新用户注册时自动分配默认套餐

**对应任务**：`24.3-24.4`

#### 9. 基础文档
- ✅ API文档更新
- ✅ 数据库表结构文档
- ✅ 管理员使用指南（基础版）

**对应任务**：`26.1-26.3`

---

## V2 - 未来增强（可以延后）

### 1. 高级统计和报表
- 📊 消费统计图表（按日期、按动作、按用户）
- 📊 套餐使用趋势分析
- 📊 收入预测报表
- 📊 导出功能（CSV/Excel）

**对应任务**：`16.2-16.5`

### 2. 性能优化
- ⚡ Redis缓存热点用户积分
- ⚡ 优化SQL查询和索引
- ⚡ 积分扣减性能监控

**对应任务**：`28.1-28.6`

### 3. 高级对账功能
- 🔍 定期对账任务
- 🔍 数据一致性检查
- 🔍 异常数据修复工具

**对应任务**：`10.3`, `28.3-28.4`

### 4. 套餐高级功能
- 🎁 套餐组合优惠
- 🎁 限时折扣
- 🎁 推荐套餐算法
- 🎁 套餐暂停/恢复

### 5. 动作价格历史
- 📜 价格修改历史记录
- 📜 价格变更通知
- 📜 动作使用统计

**对应任务**：`13.6`

### 6. 中间件和自动化
- 🛡️ 积分检查中间件
- 🛡️ 内部API认证机制

**对应任务**：`8.2`

---

## 不做（明确排除）

### 1. 支付系统
- ❌ 在线支付集成（微信、支付宝等）
- ❌ 订单管理
- ❌ 退款流程
- **原因**：应该作为独立模块，后续单独实现

### 2. 自动续费
- ❌ 自动续费逻辑
- ❌ 续费提醒
- **原因**：业务复杂，需要支付系统支持

### 3. 套餐转让和分享
- ❌ 用户间积分转移
- ❌ 套餐转让
- ❌ 积分赠送
- **原因**：容易被滥用，需要更复杂的风控

### 4. 套餐推荐算法
- ❌ 基于用户行为的套餐推荐
- ❌ 个性化套餐建议
- **原因**：需要足够的数据积累

### 5. 复杂的价格策略
- ❌ 动态定价
- ❌ 用户级别的差异定价
- ❌ 地区差异定价
- **原因**：增加系统复杂度，当前需求不明确

---

## 任务数量对比

| 阶段 | 包含的主要任务组 | 预估工作量 |
|------|-----------------|-----------|
| **MVP** | 1, 2, 3(部分), 4(部分), 5(部分), 6(部分), 7(部分), 11, 12(部分), 14(部分), 15(部分), 19(部分), 20, 24(部分) | **5-7人天** |
| **V1** | MVP + 1(完整), 5(完整), 13, 14(完整), 15(完整), 16(部分), 17, 18, 19(完整), 21, 22, 23, 24(完整), 26 | **12-15人天** |
| **V2** | V1 + 10(完整), 16(完整), 28 | **5-8人天** |

---

## 建议的实施策略

### 阶段1：MVP快速验证（1周）
1. **Day 1-2**: 数据库设计 + 后端核心服务
2. **Day 3**: 后端API + 路由
3. **Day 4**: 前端类型定义 + API封装
4. **Day 5**: 管理员界面（套餐管理、分配）
5. **Day 6**: 简历优化功能接入
6. **Day 7**: 测试 + 修复

### 阶段2：V1完整版（2周）
1. **Week 1**: 消费记录系统 + 动作计价管理 + 用户界面
2. **Week 2**: 多业务接入 + 事件日志 + 测试 + 文档

### 阶段3：V2增强版（按需）
根据实际使用情况和反馈，优先实施最需要的功能。

---

## 决策建议

### 如果资源有限，建议：
1. **先做MVP**，验证核心概念和技术方案
2. 收集用户反馈后再决定V1的具体范围
3. V2功能完全按需实施

### 如果希望一次到位，建议：
1. **直接做V1**，跳过MVP
2. 预留1-2周的缓冲时间
3. V2功能作为后续迭代

### 关键决策点
- [ ] **MVP vs 直接V1**？建议先MVP验证
- [ ] **消费记录**是否必须？建议V1加入（用于审计）
- [ ] **事件日志**是否必须？建议V1加入（用于追踪）
- [ ] **定时任务**是否必须？建议V1加入（防止过期套餐问题）
- [ ] **新用户自动分配**是否必须？建议V1加入（改善新用户体验）

---

## 风险和依赖

### MVP阶段的风险
- ⚠️ 缺少消费记录，无法进行审计和对账
- ⚠️ 缺少事件日志，问题排查困难
- ⚠️ 缺少定时任务，过期套餐可能继续可用

**缓解措施**：
- MVP仅用于内部测试或小范围试用
- 快速迭代到V1

### V1阶段的依赖
- 依赖 `add-user-event-log` 已完成（如果有）
- 需要产品确认套餐和价格策略

---

## 总结

建议采用**MVP → V1 → V2**的渐进式策略：

- **MVP (1周)**: 核心积分系统 + 基础管理界面 + 1个业务接入
- **V1 (2周)**: 完整的管理能力 + 用户界面 + 多业务接入 + 事件日志
- **V2 (按需)**: 高级统计 + 性能优化 + 增强功能

这样可以：
1. ✅ 快速验证技术方案
2. ✅ 及早发现问题
3. ✅ 根据反馈调整
4. ✅ 避免过度设计
5. ✅ 控制开发成本

