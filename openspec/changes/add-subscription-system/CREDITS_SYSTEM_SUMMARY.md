# 积分系统改进总结

## 核心改变

将原有的"额度/次数"计费模式改为**统一的积分计费模式**，并引入**动作计价表**让管理员灵活配置各种操作的积分消耗。

## 主要优势

### 1. 灵活的动作定价
- 管理员可以自定义不同操作的积分消耗量
- 无需修改代码即可调整价格
- 支持添加新的自定义动作

### 2. 统一的计费单位
- 所有操作统一使用"积分"计价
- 不再需要在各个表中维护 amount、quota 等字段
- 简化了数据结构和业务逻辑

### 3. 积分可过期
- 积分随套餐过期而作废
- 激励用户在有效期内使用
- 避免积分无限累积

### 4. 价格快照机制
- 消费记录保存积分价格快照
- 价格调整不影响历史记录
- 便于审计和对账

## 数据库改动

### 新增表：`billing_action_prices` - 动作计价表
```sql
- action_key: 动作标识（如 resume_optimize）
- action_name: 动作显示名称
- credits_cost: 单次消耗积分数
- is_active: 是否启用
```

### 修改表：`billing_packages` - 套餐表
```sql
- 改：quota_amount → credits_amount
- 改：package_type: duration/credits/hybrid/permanent
```

### 修改表：`user_billing_packages` - 用户套餐表
```sql
- 改：total_quota → total_credits
- 改：used_quota → used_credits
- 改：remaining_quota → remaining_credits
```

### 修改表：`billing_consumption_records` - 消费记录表
```sql
- 改：consumption_type → action_key
- 改：consumption_amount → credits_cost（快照）
```

## API改动

### 新增接口
- `POST /api/admin/billing/action-prices` - 创建/更新动作计价
- `GET /api/billing/action-prices` - 获取所有启用的动作计价（公共）

### 修改接口
- `POST /api/internal/billing/credits/deduct` - 扣减积分（原 quota/deduct）
  - 参数变更：需要传入 `action_key` 而不是固定数量
- `GET /api/user/billing/credits` - 获取我的积分（原 quota）

## 前端改动

### 新增页面
- `BillingActionPriceManagement.tsx` - 动作计价管理（管理员）

### 新增组件
- `CreditsDisplay.tsx` - 积分显示组件（原 QuotaDisplay）
- `ActionPriceTag.tsx` - 动作价格标签

### 功能增强
- 所有操作前显示所需积分数
- 积分不足时显示详细信息
- 过期套餐显示"积分已作废"

## 预置动作示例

系统初始化时将预置以下动作：

| 动作Key | 名称 | 积分消耗 |
|---------|------|----------|
| resume_optimize | 简历优化 | 1 |
| ai_chat | AI对话 | 1 |
| pdf_export | PDF导出 | 1 |
| advanced_analysis | 高级分析 | 3 |

管理员可以随时添加新动作或调整价格。

## 套餐类型示例

- **月度会员**：30天，100积分
- **年度会员**：365天，1500积分
- **10积分包**：10积分，永久有效
- **新用户体验包**：10积分，30天

## 业务流程

### 扣减积分流程
1. 用户执行操作（如简历优化）
2. 系统根据 `action_key='resume_optimize'` 查询动作计价表
3. 获取所需积分数（如1积分）
4. 检查用户总积分是否足够
5. 按优先级依次从用户套餐中扣减积分
6. 创建消费记录（保存 action_key 和积分快照）

### 价格调整流程
1. 管理员在动作计价管理页面修改价格
2. 系统更新动作计价表
3. 后续消费按新价格扣减
4. 历史消费记录不受影响（使用快照）

### 套餐过期流程
1. 定时任务每小时检查过期套餐
2. 将 active 状态改为 expired
3. 剩余积分全部作废
4. 用户界面显示"已过期"标记

## 迁移注意事项

### 数据迁移
1. 如果已有老数据，需要将 `quota` 相关字段迁移到 `credits`
2. 如果有历史消费记录，需要将 `consumption_type` 映射到 `action_key`

### 代码迁移
1. 所有调用额度扣减的地方需要改为传入 `action_key`
2. 前端显示"剩余次数"的地方改为"剩余积分"
3. 错误提示从"次数不足"改为"积分不足"

## 优势对比

### 原方案（额度/次数）
- ❌ 不同操作消耗固定次数（都是1次）
- ❌ 价格调整需要修改代码
- ❌ 难以支持差异化定价
- ❌ 各表分散维护 quota 字段

### 新方案（积分+计价表）
- ✅ 不同操作可配置不同积分消耗
- ✅ 价格调整通过管理界面完成
- ✅ 轻松支持差异化定价（高级功能消耗更多积分）
- ✅ 统一使用积分，数据结构清晰
- ✅ 积分可过期，避免无限累积

## 开发优先级

### P0（必须）
- 动作计价表的增删改查
- 积分扣减逻辑（基于 action_key）
- 套餐管理（使用积分）
- 用户套餐管理（使用积分）
- 消费记录（保存快照）

### P1（重要）
- 管理员界面（动作计价管理）
- 用户界面（我的积分、消费历史）
- 过期处理（积分作废）
- 事件日志集成

### P2（可选）
- 消费统计图表
- 动作使用统计
- 价格修改历史
- Redis缓存优化

## 总结

这次改进将计费系统从**固定次数模式**升级为**灵活积分模式**，核心亮点是引入**动作计价表**，让管理员可以自由配置各种操作的积分消耗。这为后续的商业化运营提供了强大的灵活性，同时也简化了数据结构和业务逻辑。

